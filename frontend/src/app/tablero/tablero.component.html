<div class="tablero-container">
  <!-- Header del juego -->
  <header class="game-header">
    <div class="header-left">
      <h1>üèÅ Regata Online</h1>
      <span class="user-info">Bienvenido, {{currentUser?.nombre}}</span>
      @if (modoMultijugador() && partidaActual()) {
        <span class="partida-info">| üéÆ Partida: {{partidaActual()!.codigo}}</span>
      }
    </div>
    <div class="header-right">
      @if (modoMultijugador()) {
        <button class="btn-secondary" (click)="volverAlLobby()">‚¨ÖÔ∏è Volver al Lobby</button>
      }
      <button class="btn-secondary" (click)="logout()">Cerrar Sesi√≥n</button>
    </div>
  </header>

<!-- Panel de control COMPACTO -->
  <div class="control-panel-header">
    <!-- Sistema de turnos y controles b√°sicos -->
    <div class="header-controls">
      @if (!juegoIniciado()) {
        <div class="game-status">
          <span>üéÆ Jugadores: {{jugadores().length}} | Barcos: {{getBarcosColocados()}}</span>
          @if (!modoMultijugador()) {
            <button class="btn-start-game small" (click)="iniciarJuego()" 
                    [disabled]="jugadores().length < 2">
              üöÄ Iniciar Juego
            </button>
          }
        </div>
      } @else {
        <div class="game-status">
          @if (modoMultijugador()) {
            <strong>{{getMensajeTurno()}}</strong>
            @if (esMiTurno()) {
              <span class="turn-indicator-active">üü¢ TU TURNO</span>
            } @else {
              <span class="turn-indicator-waiting">üî¥ ESPERANDO</span>
            }
          } @else {
            <strong>üîÑ Turno: {{jugadorActual()?.nombre}}</strong>
            <span class="turn-phase">{{faseDelTurno() === 'seleccionar-barco' ? 'Seleccionar Barco' : 'Mover Barco'}}</span>
          }
        </div>
      }

          <!-- Men√∫s desplegables -->
      <div class="dropdown-menus">
        <div class="dropdown">
          <button class="dropdown-btn" (click)="showPlayersDropdown = !showPlayersDropdown">
            üë• Jugadores ({{jugadores().length}}) ‚ñº
          </button>
          @if (showPlayersDropdown) {
            <div class="dropdown-content">
              @for (jugador of jugadores(); track jugador.id) {
                <div class="player-item-dropdown"
                     [class.current-turn]="juegoIniciado() && jugadorActual()?.id === jugador.id">
                  <span>{{jugador.nombre}} ({{getBarcoCountForJugador(jugador)}} barcos)</span>
                </div>
              }
              <button class="btn-create-small" (click)="showCreatePlayer.set(true); showPlayersDropdown = false" 
                      [disabled]="juegoIniciado()">+ Crear Jugador</button>
            </div>
          }
        </div>

        <div class="dropdown">
          <button class="dropdown-btn" (click)="showBoatsDropdown = !showBoatsDropdown">
            üö¢ Barcos ({{barcos().length}}) ‚ñº
          </button>
          @if (showBoatsDropdown) {
            <div class="dropdown-content boats-dropdown">
              @for (barco of barcos(); track barco.id) {
                <div class="boat-item-dropdown"
                     [class.selected]="selectedBarco()?.id === barco.id"
                     [class.can-select]="puedeSeleccionarBarco(barco)"
                     [class.disabled]="juegoIniciado() && !puedeSeleccionarBarco(barco)"
                     (click)="selectBarco(barco); showBoatsDropdown = false">
                  <div class="boat-mini">
                    <span class="boat-icon-small">üö¢</span>
                    <div class="boat-info-mini">
                      <div class="boat-name-small">{{getJugadorName(barco.jugadorId || 0)}} - Barco #{{barco.id}}</div>
                      <div class="boat-details-small">v({{barco.velocidadX}},{{barco.velocidadY}})
                        @if (barco.posicion) {
                          <span> | ({{barco.posicion.x}}, {{barco.posicion.y}})</span>
                        } @else {
                          <span class="pending-small">Sin colocar</span>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              }
              <button class="btn-create-small" (click)="showCreateBarco.set(true); showBoatsDropdown = false" 
                      [disabled]="juegoIniciado()">+ Crear Barco</button>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Mensajes del juego -->
    @if (gameMessage()) {
      <div class="game-message-header">
        <span class="message-text">{{gameMessage()}}</span>
        @if (ganador()) {
          <span class="winner-text">üèÜ ¬°Ganador: {{ganador()}}!</span>
        }
      </div>
    }
  </div>

  <!-- Layout principal: Tablero + Panel lateral -->
  <div class="main-layout">
    <!-- Tablero de juego -->
    <div class="game-board-container">
      <div class="board-container">
        <div class="board-title">
          <h3>Tablero de Regata ({{BOARD_WIDTH}}x{{BOARD_HEIGHT}})</h3>
          <div class="legend">
            <span class="legend-item"><span class="legend-color agua"></span>Agua</span>
            <span class="legend-item"><span class="legend-color pared"></span>Pared (X)</span>
            <span class="legend-item"><span class="legend-color partida"></span>Partida (P)</span>
            <span class="legend-item"><span class="legend-color meta"></span>Meta (M)</span>
            <span class="legend-item"><span class="legend-color valid-move"></span>Mov. Vectorial</span>
          </div>
        </div>
        
        <div class="board-grid">
          @for (fila of tablero(); track $index; let y = $index) {
            <div class="board-row">
              @for (celda of fila; track $index; let x = $index) {
                <div [class]="getCeldaClass(celda)"
                     (click)="onCeldaClick(celda)"
                     [title]="'(' + celda.x + ', ' + celda.y + ') - ' + celda.tipocelda">
                
                  @if (getBarcoAtPosition(celda.x, celda.y); as barco) {
                    <div class="barco-sprite"
                         [class.selected-barco]="selectedBarco()?.id === barco.id">
                      üö¢
                    </div>
                  }
                  
                  @if (isValidMovePosition(celda.x, celda.y)) {
                    <div class="move-indicator">
                      ‚ú®
                    </div>
                  }
                  
                  @if (celda.tipocelda !== 'A') {
                    <span class="celda-debug">{{celda.tipocelda}}</span>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Panel lateral para controles del barco -->
    @if (selectedBarco()) {
      <div class="side-panel">
        <div class="side-panel-content">
          <h3>‚ö° Control de Barco</h3>
          
          <div class="boat-info-panel">
            <div class="boat-header">
              <strong>{{getJugadorName(selectedBarco()?.jugadorId || 0)}}</strong>
              <span class="boat-id">Barco #{{selectedBarco()?.id}}</span>
            </div>
            
            <div class="boat-stats">
              <div class="stat-item">
                <span class="stat-label">Velocidad:</span>
                <span class="stat-value">v({{selectedBarco()?.velocidadX}}, {{selectedBarco()?.velocidadY}})</span>
              </div>
              @if (selectedBarco()?.posicion) {
                <div class="stat-item">
                  <span class="stat-label">Posici√≥n:</span>
                  <span class="stat-value">({{selectedBarco()?.posicion?.x}}, {{selectedBarco()?.posicion?.y}})</span>
                </div>
              }
            </div>
          </div>

        <!-- Informaci√≥n de movimiento simplificada -->
        @if (selectedBarco()?.posicion) {
          <div class="movement-info-panel">
            <h4>Movimiento del Barco</h4>
            <div class="current-velocity">
              <p><strong>Velocidad actual:</strong> v({{selectedBarco()?.velocidadX}}, {{selectedBarco()?.velocidadY}})</p>
            </div>
            
            <div class="movement-instructions">
              <p>üéØ <strong>Haz clic en las celdas coloreadas</strong> para mover el barco.</p>
              <p>‚ú® Las celdas verdes muestran todas las opciones de movimiento disponibles.</p>
              @if (juegoIniciado()) {
                <p>‚è≥ Tu turno terminar√° despu√©s del movimiento</p>
              }
            </div>
            
            @if (validMoves().length > 0) {
              <div class="possible-movements">
                <h5>Movimientos posibles:</h5>
                <div class="moves-list">
                  @for (move of validMoves(); track $index) {
                    <div class="move-option">
                      ‚Üí ({{move.x}}, {{move.y}})
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        @if (selectedBarco()?.posicion && puedeRealizarAccion()) {
          <div class="velocity-controls">
            <h4>‚ö° Control de Velocidad</h4>
            @if (!velocidadCambiadaEnTurno()) {
              <p class="velocity-instruction">
                Modifica la velocidad (X o Y, solo una por turno):
              </p>
            } @else {
              <p class="velocity-instruction completed">
                ‚úÖ Velocidad ya modificada este turno. Ahora mueve el barco.
              </p>
            }
            
            <div class="velocity-display">
              <span class="velocity-label">Velocidad actual:</span>
              <span class="velocity-value">v({{selectedBarco()?.velocidadX}}, {{selectedBarco()?.velocidadY}})</span>
            </div>

            <div class="velocity-controls-grid" [class.disabled]="velocidadCambiadaEnTurno()">
              <!-- Control de velocidad X -->
              <div class="velocity-control-group">
                <label class="velocity-label">Velocidad X (vx):</label>
                <div class="velocity-buttons">
                  <button class="velocity-btn decrease" 
                          (click)="modificarVelocidad(-1, 0)"
                          [disabled]="!puedeDisminuirVelocidadX()"
                          [title]="velocidadCambiadaEnTurno() ? 'Ya cambiaste velocidad este turno' : !puedeDisminuirVelocidadX() ? 'L√≠mite m√≠nimo alcanzado (-5)' : 'Disminuir velocidad X'">
                    ‚Üê -1
                  </button>
                  <span class="velocity-current">{{selectedBarco()?.velocidadX}}</span>
                  <button class="velocity-btn increase" 
                          (click)="modificarVelocidad(1, 0)"
                          [disabled]="!puedeAumentarVelocidadX()"
                          [title]="velocidadCambiadaEnTurno() ? 'Ya cambiaste velocidad este turno' : !puedeAumentarVelocidadX() ? 'L√≠mite m√°ximo alcanzado (+5)' : 'Aumentar velocidad X'">
                    +1 ‚Üí
                  </button>
                </div>
              </div>

              <!-- Control de velocidad Y -->
              <div class="velocity-control-group">
                <label class="velocity-label">Velocidad Y (vy):</label>
                <div class="velocity-buttons">
                  <button class="velocity-btn decrease" 
                          (click)="modificarVelocidad(0, -1)"
                          [disabled]="!puedeDisminuirVelocidadY()"
                          [title]="velocidadCambiadaEnTurno() ? 'Ya cambiaste velocidad este turno' : !puedeDisminuirVelocidadY() ? 'L√≠mite m√≠nimo alcanzado (-5)' : 'Disminuir velocidad Y'">
                    ‚Üì -1
                  </button>
                  <span class="velocity-current">{{selectedBarco()?.velocidadY}}</span>
                  <button class="velocity-btn increase" 
                          (click)="modificarVelocidad(0, 1)"
                          [disabled]="!puedeAumentarVelocidadY()"
                          [title]="velocidadCambiadaEnTurno() ? 'Ya cambiaste velocidad este turno' : !puedeAumentarVelocidadY() ? 'L√≠mite m√°ximo alcanzado (+5)' : 'Aumentar velocidad Y'">
                    +1 ‚Üë
                  </button>
                </div>
              </div>
            </div>

            <div class="velocity-info">
              @if (!velocidadCambiadaEnTurno()) {
                <p class="velocity-hint">
                  üí° Solo puedes cambiar X O Y por turno, no ambos
                </p>
              }
              @if (velocidadCambiadaEnTurno() && cambioVelocidadTurno()) {
                <p class="velocity-hint completed">
                  üîí Cambio aplicado: {{cambioVelocidadTurno()?.deltaVx !== 0 ? 'X' + (cambioVelocidadTurno()?.deltaVx! > 0 ? '+' : '') + cambioVelocidadTurno()?.deltaVx : 'Y' + (cambioVelocidadTurno()?.deltaVy! > 0 ? '+' : '') + cambioVelocidadTurno()?.deltaVy}}
                </p>
              }
              @if (juegoIniciado()) {
                <p class="turn-reminder">üéØ Es tu turno: {{jugadorActual()?.nombre}}</p>
              }
            </div>
          </div>
        }

        @if (!selectedBarco()?.posicion) {
          <div class="placement-hint">
            <p>üèÅ Haz clic en una casilla de Partida (P - naranja) para colocar el barco</p>
          </div>
        }

        <!-- Botones de administraci√≥n del barco -->
        <div class="boat-admin-panel">
          <h4>‚öôÔ∏è Administrar Barco</h4>
          <div class="admin-buttons">
            <button class="btn-admin btn-edit" (click)="editarBarcoSeleccionado()">
              ‚úèÔ∏è Editar
            </button>
            <button class="btn-admin btn-delete" (click)="eliminarBarcoSeleccionado()">
              üóëÔ∏è Eliminar
            </button>
            <button class="btn-admin btn-list" (click)="irAListaBarcos()">
              üìã Ver Lista
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>

<!-- Modal para crear jugador -->
  @if (showCreatePlayer()) {
    <div class="modal-overlay" (click)="showCreatePlayer.set(false)">
      <div class="modal" (click)="$event.stopPropagation()">
        <h3>Crear Nuevo Jugador</h3>
        <form (ngSubmit)="createPlayer()">
          <div class="form-group">
            <label for="playerName">Nombre del Jugador</label>
            <input id="playerName" 
                   type="text" 
                   [(ngModel)]="newPlayerName"
                   name="playerName"
                   placeholder="Ingresa el nombre"
                   required>
          </div>
          <div class="modal-buttons">
            <button type="button" class="btn-secondary" (click)="showCreatePlayer.set(false)">Cancelar</button>
            <button type="submit" class="btn-primary">Crear</button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal para crear barco -->
  @if (showCreateBarco()) {
    <div class="modal-overlay" (click)="showCreateBarco.set(false)">
      <div class="modal" (click)="$event.stopPropagation()">
        <h3>Crear Nuevo Barco</h3>
        <form (ngSubmit)="createBarco()">
          <div class="form-group">
            <label for="jugadorId">Jugador</label>
            <select id="jugadorId" 
                    [(ngModel)]="newBarco.jugadorId"
                    name="jugadorId"
                    required>
              <option [value]="0">Selecciona un jugador</option>
              @for (jugador of jugadores(); track jugador.id) {
                <option [value]="jugador.id">
                  {{jugador.nombre}}
                </option>
              }
            </select>
          </div>

          <div class="velocity-group">
            <h4>Velocidad Vectorial</h4>
            <div class="velocity-inputs">
              <div class="form-group">
                <label for="velocidadX">Velocidad X (vx)</label>
                <input id="velocidadX" 
                       type="number" 
                       min="-3" 
                       max="3"
                       [(ngModel)]="newBarco.velocidadX"
                       name="velocidadX"
                       required>
                <small>Componente horizontal de velocidad (-3 a 3)</small>
              </div>

              <div class="form-group">
                <label for="velocidadY">Velocidad Y (vy)</label>
                <input id="velocidadY" 
                       type="number" 
                       min="-3" 
                       max="3"
                       [(ngModel)]="newBarco.velocidadY"
                       name="velocidadY"
                       required>
                <small>Componente vertical de velocidad (-3 a 3)</small>
              </div>
            </div>
            <p class="velocity-explanation">
              üéØ El barco se mover√° seg√∫n el vector v({{newBarco.velocidadX}}, {{newBarco.velocidadY}}) cada turno.
              Durante el juego podr√°s modificar cada componente en ¬±1.
            </p>
          </div>

          <div class="modal-buttons">
            <button type="button" class="btn-secondary" (click)="showCreateBarco.set(false)">Cancelar</button>
            <button type="submit" class="btn-primary">Crear</button>
          </div>
        </form>
      </div>
    </div>
  }
</div>